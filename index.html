<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KikoMessenger Ultimate</title>
    <link id="manifest-placeholder" rel="manifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #202225;
            --bg-sidebar: #2f3136;
            --bg-chat: #36393f;
            --bg-msg: #2f3136;
            --accent: #5865f2;
            --text-main: #dcddde;
            --text-muted: #72767d;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- LAYOUT --- */
        #app-ui { display: flex; width: 100%; height: 100%; }
        
        /* SIDEBAR (Salons) */
        .sidebar { width: 280px; background: var(--bg-sidebar); display: flex; flex-direction: column; flex-shrink: 0; transition: transform 0.3s; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #202225; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .channel-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .category { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: bold; margin-top: 15px; margin-bottom: 5px; padding-left: 5px; }
        .channel { padding: 8px 10px; margin: 2px 0; border-radius: 4px; cursor: pointer; color: #8e9297; display: flex; align-items: center; }
        .channel:hover { background: rgba(79,84,92,0.32); color: var(--text-main); }
        .channel.active { background: rgba(79,84,92,0.6); color: white; }
        .channel i { margin-right: 8px; width: 20px; text-align: center; }

        /* USER BAR (Bas de sidebar) */
        .user-bar { background: #292b2f; padding: 10px; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: gray; }
        .user-name { font-weight: bold; font-size: 0.9rem; }
        .user-code { font-size: 0.7rem; color: var(--text-muted); }
        .settings-btn { background: none; border: none; color: var(--text-main); cursor: pointer; font-size: 1.1rem; }

        /* MAIN CHAT AREA */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        .chat-header { padding: 15px; border-bottom: 1px solid #26272d; font-weight: bold; display: flex; align-items: center; shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .mobile-menu-btn { display: none; margin-right: 15px; background: none; border: none; color: white; font-size: 1.2rem; }
        
        #messages-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { display: flex; gap: 15px; padding: 2px 0; }
        .msg:hover { background: rgba(0,0,0,0.05); }
        .msg-content { display: flex; flex-direction: column; }
        .msg-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .msg-author { font-weight: bold; cursor: pointer; }
        .msg-time { font-size: 0.7rem; color: var(--text-muted); }
        .msg-text { word-break: break-word; line-height: 1.4; }
        .msg-image { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 5px; cursor: pointer; }

        /* INPUT AREA */
        .input-area { padding: 20px; background: var(--bg-chat); }
        .input-wrapper { background: #40444b; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .chat-input { background: transparent; border: none; color: white; flex-grow: 1; outline: none; font-size: 1rem; }
        .upload-btn { color: #b9bbbe; cursor: pointer; font-size: 1.2rem; }
        .upload-btn:hover { color: var(--text-main); }

        /* SETTINGS MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #36393f; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem; }
        .setting-group { margin-bottom: 20px; border-bottom: 1px solid #4f545c; padding-bottom: 20px; }
        .setting-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #b9bbbe; }
        .setting-input { width: 100%; padding: 10px; background: #202225; border: 1px solid #202225; color: white; border-radius: 4px; box-sizing: border-box; }
        .btn-save { background: var(--success); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        
        /* AUTH SCREEN */
        .auth-container { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .auth-box { background: #2f3136; padding: 40px; border-radius: 5px; width: 100%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-align: center; }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; background: #202225; border: 1px solid #202225; color: white; border-radius: 3px; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 3px; font-weight: bold; cursor: pointer; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; z-index: 100; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            .mobile-menu-btn { display: block; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-ui" class="auth-container">
        <div class="auth-box">
            <h2 id="auth-title" style="color:white; margin-bottom:20px;">Connexion</h2>
            <input type="text" id="auth-pseudo" placeholder="Pseudo" class="hidden">
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-pass" placeholder="Mot de passe">
            <button id="auth-btn">Se connecter</button>
            <p id="auth-toggle" style="margin-top:15px; color: var(--accent); cursor: pointer; font-size:0.9rem;">Créer un compte</p>
        </div>
    </div>

    <div id="app-ui" class="hidden">
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">KikoMessenger <span style="font-size:0.5rem; color:orange;">ULTIMATE</span></div>
            
            <div class="channel-list">
                <div class="category">Salons Textuels</div>
                <div class="channel active" onclick="changeChannel('general', 'text')"><i class="fas fa-hashtag"></i> général</div>
                <div class="channel" onclick="changeChannel('blabla', 'text')"><i class="fas fa-hashtag"></i> blabla</div>
                <div class="channel" onclick="changeChannel('media', 'text')"><i class="fas fa-images"></i> média-gif</div>
                <div class="channel" onclick="changeChannel('gaming', 'text')"><i class="fas fa-gamepad"></i> gaming</div>

                <div class="category">Salons Vocaux</div>
                <div class="channel" onclick="joinVoice('vocal1')"><i class="fas fa-volume-up"></i> Vocal 1 <span id="count-vocal1" style="font-size:0.7rem; margin-left:auto;">0</span></div>
                <div class="channel" onclick="joinVoice('vocal2')"><i class="fas fa-volume-up"></i> Vocal 2 <span id="count-vocal2" style="font-size:0.7rem; margin-left:auto;">0</span></div>
                <div class="channel" onclick="joinVoice('vocal3')"><i class="fas fa-volume-up"></i> Vocal 3 <span id="count-vocal3" style="font-size:0.7rem; margin-left:auto;">0</span></div>
            </div>

            <div class="user-bar">
                <div class="user-info">
                    <img id="current-user-img" src="" class="avatar">
                    <div style="display:flex; flex-direction:column;">
                        <span id="current-user-name" class="user-name">...</span>
                        <span id="current-user-tag" class="user-code">En ligne</span>
                    </div>
                </div>
                <button class="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <div class="chat-area" onclick="closeSidebarMobile()">
            <div class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleSidebar(event)"><i class="fas fa-bars"></i></button>
                <span id="header-title"><i class="fas fa-hashtag"></i> général</span>
            </div>

            <div id="messages-container"></div>

            <div class="input-area" id="input-area">
                <div class="input-wrapper">
                    <label for="file-upload" class="upload-btn"><i class="fas fa-plus-circle"></i></label>
                    <input type="file" id="file-upload" accept="image/*" class="hidden">
                    <input type="text" id="msg-input" class="chat-input" placeholder="Envoyer un message...">
                    <button id="send-btn" class="upload-btn" style="color:var(--accent)"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div id="voice-ui" class="hidden" style="background:var(--bg-chat); padding:20px; text-align:center; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <i class="fas fa-microphone-alt" style="font-size: 50px; color: var(--success); margin-bottom:20px;"></i>
                <h2>Connecté au salon vocal</h2>
                <p>En discussion...</p>
                <button onclick="leaveVoice()" style="background:var(--danger); color:white; padding:10px 30px; border:none; border-radius:5px; margin-top:20px;">Déconnecter</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h2 style="margin-bottom:20px;">Paramètres Utilisateur</h2>

            <div class="setting-group" style="text-align:center;">
                <img id="settings-avatar-preview" src="" class="avatar" style="width:80px; height:80px; margin-bottom:10px;">
                <br>
                <label for="avatar-upload" style="cursor:pointer; color:var(--accent);">Changer la photo de profil</label>
                <input type="file" id="avatar-upload" accept="image/*" class="hidden">
            </div>

            <div class="setting-group">
                <label>Pseudo</label>
                <input type="text" id="settings-pseudo" class="setting-input">
                <small style="color: #ed4245; display:none;" id="pseudo-error">Un changement tous les 30 jours.</small>
            </div>

            <div class="setting-group">
                <label>Notifications</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="settings-notif"> <span style="font-size:0.9rem;">Activer les sons</span>
                </div>
            </div>

            <button class="btn-save" onclick="saveSettings()">Enregistrer les modifications</button>
            <button onclick="logout()" style="width:100%; background:var(--danger); padding:10px; border:none; border-radius:4px; color:white; font-weight:bold; margin-top:10px; cursor:pointer;">Se déconnecter</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // --- 1. CONFIGURATION (REMPLACE PAR TES CLÉS SI NÉCESSAIRE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEjPw8UHPzva9Ccvqm3mG1z19SGIio3pk",
            authDomain: "mydiscord-cf98a.firebaseapp.com",
            projectId: "mydiscord-cf98a",
            storageBucket: "mydiscord-cf98a.firebasestorage.app", // Important pour les images
            messagingSenderId: "834303173284",
            appId: "1:834303173284:web:1d10a71974926cfa77fc31"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 2. MANIFEST PWA ---
        const manifest = {
            "name": "KikoMessenger",
            "short_name": "Kiko",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#2c2f33",
            "theme_color": "#202225",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/5968/5968756.png", "sizes": "512x512", "type": "image/png"}]
        };
        document.querySelector('#manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));

        // --- 3. VARIABLES GLOBALES ---
        let currentUserData = null;
        let currentChannelID = 'general';
        let unsubscribeChat = null;
        let isUploading = false;

        // --- 4. GESTION AUTHENTIFICATION ---
        const authUI = document.getElementById('auth-ui');
        const appUI = document.getElementById('app-ui');
        let isLoginMode = true;

        document.getElementById('auth-toggle').onclick = () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-pseudo').classList.toggle('hidden');
            document.getElementById('auth-title').innerText = isLoginMode ? "Connexion" : "Créer un compte";
            document.getElementById('auth-btn').innerText = isLoginMode ? "Se connecter" : "S'inscrire";
            document.getElementById('auth-toggle').innerText = isLoginMode ? "Créer un compte" : "J'ai déjà un compte";
        };

        document.getElementById('auth-btn').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const pseudo = document.getElementById('auth-pseudo').value;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    if (!pseudo) throw new Error("Pseudo requis !");
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    // Création profil complet
                    await setDoc(doc(db, "users", res.user.uid), {
                        pseudo: pseudo,
                        email: email,
                        photoURL: "https://ui-avatars.com/api/?name=" + pseudo + "&background=random",
                        role: (email === "henriquebdscosta33@gmail.com") ? "admin" : "user",
                        lastPseudoChange: null,
                        createdAt: serverTimestamp()
                    });
                }
            } catch (e) { alert("Erreur : " + e.message); }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Charger infos utilisateur
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUserData = snap.data();
                    updateUserUI();
                    authUI.classList.add('hidden');
                    appUI.classList.remove('hidden');
                    loadMessages(currentChannelID); // Charger salon par défaut
                }
            } else {
                appUI.classList.add('hidden');
                authUI.classList.remove('hidden');
            }
        });

        function updateUserUI() {
            document.getElementById('current-user-name').innerText = currentUserData.pseudo;
            document.getElementById('current-user-img').src = currentUserData.photoURL;
        }

        // --- 5. SYSTÈME DE SALONS ---
        window.changeChannel = (channelId, type) => {
            // UI Update
            document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Logic
            document.getElementById('voice-ui').classList.add('hidden');
            document.getElementById('messages-container').classList.remove('hidden');
            document.getElementById('input-area').classList.remove('hidden');
            
            currentChannelID = channelId;
            document.getElementById('header-title').innerHTML = `<i class="fas fa-hashtag"></i> ${channelId}`;
            closeSidebarMobile();
            loadMessages(channelId);
        };

        window.joinVoice = (voiceId) => {
            // Simulation UI Vocal
            document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('messages-container').classList.add('hidden');
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('voice-ui').classList.remove('hidden');
            
            closeSidebarMobile();
            // Ici on pourrait ajouter WebRTC, mais pour l'instant c'est une simulation visuelle
        };

        window.leaveVoice = () => {
            changeChannel('general', 'text');
        };

        // --- 6. CHAT & MESSAGERIE ---
        function loadMessages(channelId) {
            if (unsubscribeChat) unsubscribeChat(); // Stop écoute précédente
            
            const q = query(collection(db, "messages"), where("channel", "==", channelId), orderBy("createdAt", "asc"));
            
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = "";
                
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const date = msg.createdAt ? new Date(msg.createdAt.seconds * 1000) : new Date();
                    const time = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    let content = `<div class="msg-text">${msg.text}</div>`;
                    if (msg.type === 'image') {
                        content = `<img src="${msg.mediaUrl}" class="msg-image" onclick="window.open(this.src)">`;
                    }

                    container.innerHTML += `
                        <div class="msg">
                            <img src="${msg.userPhoto || 'https://ui-avatars.com/api/?name=?'}" class="avatar">
                            <div class="msg-content">
                                <div class="msg-header">
                                    <span class="msg-author" style="color:${msg.role==='admin'?'#ed4245':'white'}">${msg.pseudo}</span>
                                    ${msg.role==='admin' ? '<span class="admin-tag">ADMIN</span>' : ''}
                                    <span class="msg-time">${time}</span>
                                </div>
                                ${content}
                            </div>
                        </div>`;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        // ENVOI MESSAGE TEXTE
        document.getElementById('send-btn').onclick = sendMessage;
        document.getElementById('msg-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = "";
            await addDoc(collection(db, "messages"), {
                text: text,
                pseudo: currentUserData.pseudo,
                userPhoto: currentUserData.photoURL,
                uid: auth.currentUser.uid,
                role: currentUserData.role,
                channel: currentChannelID,
                type: 'text',
                createdAt: serverTimestamp()
            });
        }

        // ENVOI IMAGE (Stockage Firebase)
        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Bloquer upload dans général si on veut (optionnel)
            // if (currentChannelID !== 'media' && currentChannelID !== 'general') { alert("Images autorisées dans Média uniquement"); return; }

            const storageRef = ref(storage, `chat_images/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snapshot.ref);
                
                await addDoc(collection(db, "messages"), {
                    text: "",
                    mediaUrl: url,
                    pseudo: currentUserData.pseudo,
                    userPhoto: currentUserData.photoURL,
                    uid: auth.currentUser.uid,
                    role: currentUserData.role,
                    channel: currentChannelID,
                    type: 'image',
                    createdAt: serverTimestamp()
                });
            } catch (err) { alert("Erreur d'upload : Active Firebase Storage dans la console !"); }
        });

        // --- 7. PARAMÈTRES UTILISATEUR ---
        window.openSettings = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('settings-pseudo').value = currentUserData.pseudo;
            document.getElementById('settings-avatar-preview').src = currentUserData.photoURL;
        };

        window.closeSettings = () => {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.saveSettings = async () => {
            const newPseudo = document.getElementById('settings-pseudo').value;
            const file = document.getElementById('avatar-upload').files[0];
            let newPhotoURL = currentUserData.photoURL;

            // 1. Vérif Pseudo (30 jours)
            if (newPseudo !== currentUserData.pseudo) {
                const now = new Date();
                const lastChange = currentUserData.lastPseudoChange ? currentUserData.lastPseudoChange.toDate() : new Date(0);
                const diffTime = Math.abs(now - lastChange);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                if (diffDays < 30) {
                    alert(`Attends encore ${30 - diffDays} jours pour changer de pseudo.`);
                    return;
                }
            }

            // 2. Upload Avatar
            if (file) {
                const avatarRef = ref(storage, `avatars/${auth.currentUser.uid}`);
                const snap = await uploadBytes(avatarRef, file);
                newPhotoURL = await getDownloadURL(snap.ref);
            }

            // 3. Save DB
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                pseudo: newPseudo,
                photoURL: newPhotoURL,
                lastPseudoChange: (newPseudo !== currentUserData.pseudo) ? serverTimestamp() : currentUserData.lastPseudoChange
            });

            // Update Local
            currentUserData.pseudo = newPseudo;
            currentUserData.photoURL = newPhotoURL;
            updateUserUI();
            closeSettings();
            alert("Profil mis à jour !");
        };

        // UI Helpers
        window.toggleSidebar = (e) => {
            e.stopPropagation();
            document.getElementById('sidebar').classList.toggle('open');
        };
        window.closeSidebarMobile = () => {
            document.getElementById('sidebar').classList.remove('open');
        };
        window.logout = () => signOut(auth);

    </script>
</body>
</html>
